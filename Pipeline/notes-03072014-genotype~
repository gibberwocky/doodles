
# Working directory
DUMP="/home/dwragg/work/tmp"
PIPE="/home/dwragg/work/Pipeline"


# Merge sample VCFs into single VCF file
FL=(/home/dwragg/work/tmp/*/vcfs/FL*L00?.vcf.gz)
#JFM=( ${JFM1[@]} ${JFM2[@]} )
VCFOUT=${DUMP}/vcfs/FL-sites.vcf.gz

# Generate VCF file containing merged sites but not genotypes
module load bioinfo/bcftools
bcftools merge ${FL[@]} \
  | bcftools view --types snps -G -M 2 -g ^het -O z -o ${VCFOUT} -
tabix -p vcf ${VCFOUT}

# Generate BAM list
FL_BAM=(/home/dwragg/work/tmp/FL*/FL*.bam)
ls ${FL_BAM[@]} > ${DUMP}/vcfs/FL_BAM.list

# Genotype samples with GATK using sites from previous step
cd ${DUMP}
qsub -q workq -l mem=4G -l h_vmem=16G -pe parallel_smp 8 -o ${DUMP}/vcfs -e ${DUMP}/vcfs ${PIPE}/genotype.sh -i ${PIPE}/params -s ${VCFOUT} -b ${DUMP}/vcfs/FL_BAM.list -o ${DUMP}/vcfs/FL_all.vcf.gz


# Filter down to SNPs again, and exclude sites with uncalled genotype
# This is necessary before running the imputation script
module load bioinfo/bcftools
bcftools view --types snps -U -M 2 -g ^het -O v -o ${DUMP}/vcfs/tmp.vcf ${DUMP}/vcfs/FL_all.vcf.gz


# Try imputing missing with BEAGLE again...

# Impute missing
DUMP="/home/dwragg/work/tmp"
PERLSCRIPTS=/home/dwragg/save/Scripts/Perl
perl ${PERLSCRIPTS}/test.pl ${DUMP}/vcfs/tmp.vcf > ${DUMP}/vcfs/imp.vcf

# Checked in GenABEL, imputation worked OK:
vcftools --vcf ${DUMP}/vcfs/imp.vcf \
  --plink-tped --out ${DUMP}/vcfs/bees



