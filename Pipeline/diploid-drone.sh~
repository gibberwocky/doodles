#!/bin/bash
#$ -M david.wragg@toulouse.inra.fr
#$ -m a
module load bioinfo/bcftools

# set -e will cause script to terminate on an error, set +e allows it to continue
set -e

PERL="/save/dwragg/Scripts/Perl"
V=
A=
B=
OUT=
ID=

while getopts ":v:a:b:s:o:" opt; do
  case $opt in
    v) V=${OPTARG};;
    a) A=${OPTARG};;
    b) B=${OPTARG};;
    o) OUT=${OPTARG};;
    s) ID=${OPTARG};;
  esac
done

if [[ -z ${V} ]] | [[ -z ${A} ]] | [[ -z ${B} ]] | [[ -z ${OUT} ]] | [[ -z ${ID} ]]
then
  exit 1
fi



# Extract a pair of drones to vcf
bcftools view --types snps -M 2 -O v \
  -s ${A},${B} \
  -o ${OUT}/${ID} \
  ${V}

# Create diploid drone
perl ${PERL}/diploid-drone-v2.pl ${OUT}/${ID} ${ID} > ${OUT}/${ID}.vcf
rm ${OUT}/${ID}
sed -i '/^$/d' ${OUT}/${ID}.vcf

# Extract drone from VCF
bcftools view --types snps -M 2 -O v \
  -s ${ID} \
  -o ${OUT}/${ID}.vcf \
  ${OUT}/${ID}-fix.vcf
rm ${OUT}/${ID}-fix.vcf


