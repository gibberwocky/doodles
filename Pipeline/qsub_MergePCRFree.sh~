# !/bin/bash
# IEKNGHER1ujm

# 1) Merge BAMs for:
#	JFM8_ACTTGA_L001
# 	JFM8-PCRfree_TCGAAG_L001
#	JFM11_GGCTAC_L001
#	JFM11-PCRfree_TCGGCA_L001
# 2) Stats, SNPs


# Samples
SAMPLES=('JFM8' 'JFM11')
PCR=('JFM8_ACTTGA_L001' 'JFM11_GGCTAC_L001')
NOPCR=('JFM8-PCRfree_TCGAAG_L001' 'JFM11-PCRfree_TCGGCA_L001')

# Set root paths
DUMP="/home/dwragg/work/Analysis"
PIPE="/home/dwragg/work/Pipeline"
IN="/home/dwragg/work/Project_ROYALBEE.301/Run_Pool1.4968/RawData/"

# Set sample to analyse
IDX=1
ID=${SAMPLES[${IDX}]}
RUN1=${PCR[${IDX}]}
RUN2=${NOPCR[${IDX}]}




# Prep
mkdir -p ${DUMP}/logs/${ID}
mkdir -p ${DUMP}/${ID}/logs
mkdir -p ${DUMP}/${ID}/metrics
mkdir -p ${DUMP}/${ID}/vcfs

# Create soft links to data on seqapipop
mkdir -p ${DUMP}/${RUN1}
ln -s /save/seqapipop/Data/${RUN1}/${RUN1}_bootstrap.bam /work/dwragg/Analysis/${RUN1}/${RUN1}_bootstrap.bam
mkdir -p ${DUMP}/${RUN2}
ln -s /save/seqapipop/Data/${RUN2}/${RUN2}_bootstrap.bam /work/dwragg/Analysis/${RUN2}/${RUN2}_bootstrap.bam

# Merge BAMs
cd ${DUMP}
qsub -q workq -l mem=4G -l h_vmem=48G -pe parallel_smp 1 \
  -o ${DUMP}/logs/${ID} \
  -e ${DUMP}/logs/${ID} \
  ${PIPE}/mergeBAMs.sh -s ${ID} \
    -a ${DUMP}/${RUN1}/${RUN1}_bootstrap.bam \
    -b ${DUMP}/${RUN2}/${RUN2}_bootstrap.bam \
    -o ${DUMP}


# <- to here


# Call stats
cd ${DUMP}
qsub -q workq -l mem=4G -l h_vmem=48G -pe parallel_smp 4 \
  -o ${DUMP}/logs/${ID} \
  -e ${DUMP}/logs/${ID} \
  ${PIPE}/stat.sh -i ${PIPE}/params -p "T" -q "F" -s ${ID} -f ${IN} -o ${DUMP}

# Call SNPs
mkdir -p ${DUMP}/logs/${ID}
cd ${DUMP}
qsub -q unlimitq -l mem=4G -l h_vmem=48G -pe parallel_smp 4 \
  -o ${DUMP}/logs/${ID} \
  -e ${DUMP}/logs/${ID} \
  ${PIPE}/snps.sh -i ${PIPE}/params -p "T" -q "F" -s ${ID} -f ${IN} -o ${DUMP}


