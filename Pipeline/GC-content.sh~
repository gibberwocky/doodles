#!/bin/bash
#$ -M david.wragg@toulouse.inra.fr
#$ -m a

# Modify environment for Java7
module load bioinfo/Java7 

# set -e will cause script to terminate on an error, set +e allows it to continue
set -e

# ==============================================================================
# stat.sh
# ==============================================================================
echo -e "\n\e[1m\e[34m====================================\e[0m"
echo -e "\e[93m\e[1mSeqApiPop\e[0m\e[93m: Mapping statistics\e[0m"
echo -e "\e[1m\e[34m====================================\e[0m"
usage()
{
  echo -e "\n\e[96mUsage\e[0m"
  echo -e "\e[92m   $0 -s <sample name> -f <path to fastq reads> -o <output path> [options]\e[0m"
  echo -e "\n\e[96mDetails\e[0m"
  echo -e "\e[92mThis pipeline has been developed to map Illumina HiSeq reads generated for the SeqApiPop project. All of the parameters in the parameter file require setting. This module requires the installation of GATK, Picard, SAMtools, BEDtools, VCFtools and R.\e[0m"
  echo -e "\n\e[96mOPTIONS:\e[0m"
  echo -e "\e[92m\t-i <str>\tPath to input file containing pipeline parameters [defafult = /save/seqapipop/Scripts/params]\e[0m"
  echo -e "\n\e[96mRequires\e[0m"
  echo -e "\e[92mGATK\e[0m"
  echo -e "\e[92mPicard\e[0m"
  echo -e "\e[92mSAMtools\e[0m"
  echo -e "\e[92mBEDtools\e[0m"
  echo -e "\e[92mCoverage-Poisson.R\e[0m"
  echo -e "\e[92mPlot-GATKcov.R\e[0m"
  echo -e "\e[92mPlot-GATKcovStats.R\e[0m"
  echo -e "\e[92mPlot-Flagstat.R\e[0m"
  echo -e "\n"

}

# Clear variables and set defaults for nThreads, BQSR bootstraps and RAM
INFILE=/save/seqapipop/Scripts/params
REF=
IN=
OUT=
SAMPLE=
BWA=
PICARD=
GATK=
PLATYPUS=
VCFT=
PERLSCRIPTS=
RSCRIPTS=
BAYSIC=
BEAGLE=

while getopts ":i:f:s:o:" opt; do
  case $opt in
    i) INFILE=${OPTARG};;
    f) IN=${OPTARG};;
    s) SAMPLE=${OPTARG};;
    o) OUT=${OPTARG};;
  esac
done

if [[ -z ${INFILE} ]] | [[ -z ${SAMPLE} ]] | [[ -z ${OUT} ]]
then
  usage
  exit 1
fi






# Depth of coverage via GATK
echo -e "\e[91m[1/${STEPS}] GATK:DepthOfCoverage \n\t\e[94m\e[1m<- \e[0m\e[92m${OUT}/${SAMPLE}/${SAMPLE}_bootstrap.bam \n\t\e[94m\e[1m-> \e[0m\e[96m${OUT}/${SAMPLE}/metrics/${SAMPLE}_GATKcov\e[0m"
logfile=${OUT}/${SAMPLE}/logs/${SAMPLE}_DpethOfCoverage.err
java -d64 -jar ${GATK}/GenomeAnalysisTK.jar \
  -T DepthOfCoverage \
  -R ${REF} \
  -I ${OUT}/${SAMPLE}/${SAMPLE}_bootstrap.bam \
  -o ${OUT}/${SAMPLE}/metrics/${SAMPLE}_GATKcov \
  -ct 2 -ct 5 -ct 8 \
  --omitDepthOutputAtEachBase \
  --omitIntervalStatistics \
  --omitLocusTable \
  -l FATAL \
  2> >(tee "$logfile")
${RSCRIPTS}/Plot-GATKcov.R ${SAMPLE} ${OUT}/${SAMPLE}/metrics/${SAMPLE}_GATKcov.sample_summary
${RSCRIPTS}/Plot-GATKcovStats.R ${SAMPLE} ${OUT}/${SAMPLE}/metrics/${SAMPLE}_GATKcov.sample_statistics

