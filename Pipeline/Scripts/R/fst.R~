#!/usr/bin/env Rscript

# ==============================================================================
# NOTES
# ==============================================================================

# The following functions are inlcuded in this script:

# func_majA	- To identify and count major allele
# func_minA	- To identify and count minor allele
# func_Fst 	- To calculate unbias Fst and Jost D using mean and median

# ==============================================================================

args <- commandArgs(T)
# [1] path
# [2] ped
# [3] map
# [4] pheno
# [5] chromosome
# [6] window size
# [7] chrinfo
# [8] output

#args <- c("/home/dwragg/work/Analysis/vcfs", "EurBee-bayes.ped", "EurBee-R.map", "EurBee-bayes.pheno", "1", "25000", "/save/dwragg/Apis/chrInfo", "/home/dwragg/work/Analysis/selection")


library("GenABEL")

# Set working directory
setwd(args[1])

# Import PED data
convert.snp.ped(pedfile=args[2], mapfile=args[3], out="gen0i1.raw", format = "premakeped", traits = 1, strand = "u", bcast = 10000000, wslash=F, mapHasHeaderLine=F)
raw <- load.gwaa.data(phe=args[4], gen = "gen0i1.raw", force = T, sort=T)

# Load table of chromosome lengths
chrInfo <- read.table(args[7], sep="\t", header=F, strings=F)

# ==============================================================================
# Generate windows
# ==============================================================================

# Get chromosome 24 Length
var_chr <- as.numeric(args[5])
var_chrL <- as.numeric(chrInfo[which(chrInfo$V1==var_chr), 2])

# Specify window size
var_winL <- as.numeric(args[6])
var_overlap <- 0.5

# Calculates intervals based on parameters
start <- as.integer(seq(1,var_chrL, by=var_winL*(var_overlap)))
chr <- rep(var_chr, length(start))
stop <- as.integer(start + var_winL)
bed <- NULL
bed <- data.frame(chr, start, stop, stringsAsFactors=F)
bed[nrow(bed),ncol(bed)] <- var_chrL

# ==============================================================================



# ==============================================================================
# Count genotype and major/minor allele frequencies
# ==============================================================================

# Subset to chromosome
data <- raw[,which(raw@gtdata@chromosome==var_chr)]
rm(raw)

# Get list of SNP positions
var_Map <- data@gtdata@map

# Get list of SNP names
var_SNP <- data@gtdata@snpnames

# Get number of SNPs per window
nSNPs <- lapply(as.integer(rownames(bed)), 
	function(x) sum(var_Map%in%bed[x,]$start:bed[x,]$stop))

# Get list of SNPs per window
SNPs <- lapply(as.integer(rownames(bed)),
	function(x) var_SNP[var_Map%in%bed[x,]$start:bed[x,]$stop])


# Record values and label columns
bed[,4] <- unlist(nSNPs)
names(bed)[4] <- "n_SNPs"



# ==============================================================================
# Calculate Fst and Jost's D
# ==============================================================================

# Function: unbias.Fst
func_Fst <- function(dat.geno, pop1.inds, pop2.inds, SNPs){
	
    # Total population
    Ht.dat <- dat.geno[c(pop1.inds, pop2.inds),SNPs]
    Ht.11 <- summary(Ht.dat)$P.11
    Ht.12 <- summary(Ht.dat)$P.12
    Ht.22 <- summary(Ht.dat)$P.22
    Ht.n <- Ht.11 + Ht.12 + Ht.22
    Ht <- (((2*Ht.11)+Ht.12)/(2*Ht.n)) * (1 - (((2*Ht.11)+Ht.12)/(2*Ht.n))) * 2
    
    # Pop1
    Hs1.dat <- dat.geno[pop1.inds, SNPs]
    Hs1.11 <- summary(Hs1.dat)$P.11
    Hs1.12 <- summary(Hs1.dat)$P.12
    Hs1.22 <- summary(Hs1.dat)$P.22
    Hs1.n <- Hs1.11 + Hs1.12 + Hs1.22
    Hs1 <- (((2*Hs1.11)+Hs1.12)/(2*Hs1.n)) * (1 - (((2*Hs1.11)+Hs1.12)/(2*Hs1.n))) * 2
    
    # Pop2
    Hs2.dat <- dat.geno[pop2.inds, SNPs]
    Hs2.11 <- summary(Hs2.dat)$P.11
    Hs2.12 <- summary(Hs2.dat)$P.12
    Hs2.22 <- summary(Hs2.dat)$P.22
    Hs2.n <- Hs2.11 + Hs2.12 + Hs2.22
    Hs2 <- (((2*Hs2.11)+Hs2.12)/(2*Hs2.n)) * (1 - (((2*Hs2.11)+Hs2.12)/(2*Hs2.n))) * 2
    
    # Weighted Fst
    wHs <- ( (Hs1*Hs1.n) + (Hs2*Hs2.n) ) / Ht.n
    fst1 <- round(median((Ht-wHs)/Ht, na.rm=T), 3)
    fst2 <- round(mean((Ht-wHs)/Ht, na.rm=T), 3)

    # D (Joost, 2008)
    k <- 2
    D1 <- round((k/(k-1)) * median ( (Ht-wHs) / (1-wHs), na.rm=T ), 3)
    D2 <- rounnd((k/(k-1)) * mean ( (Ht-wHs) / (1-wHs), na.rm=T ), 3)

    rm(k, dat.geno, pop1.inds, pop2.inds, SNPs, wHs)
    rm(Ht.dat, Ht.11, Ht.12, Ht.22, Ht.n, Ht)
    rm(Hs1.dat, Hs1.11, Hs1.12, Hs1.22, Hs1.n, Hs1)
    rm(Hs2.dat, Hs2.11, Hs2.12, Hs2.22, Hs2.n, Hs2)
    return(c(fst1, fst2, D1, D2))
  
}# End of function


# Apply function to data
fst <- lapply(SNPs, function(x) if(length(x)>0) {
	func_Fst(data@gtdata, 
		data@phdata[which(data@phdata$pop==1),]$id,
		data@phdata[which(data@phdata$pop==2),]$id,
		x)} else {c(0,0,0,0)})


bed[,5:8] <- unlist(fst)
names(bed)[5:8] <- c("Fst_median", "Fst_mean", "D_median", "D_mean")

# ==============================================================================


fname <- paste(args[8], "/Fst-chr", var_chr, "-win-", var_winL, ".txt", sep="")
write.table(bed, fname, sep="\t", row.names=T, col.names=T, append=F, quote=F)







